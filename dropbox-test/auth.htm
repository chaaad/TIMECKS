<!doctype html>
<html>

<head>
    <title>Dropbox JavaScript SDK</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/2.0.3/fetch.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/promise-polyfill@7/dist/polyfill.min.js"></script>
    <!--script src="/__build__/Dropbox-sdk.min.js"></script-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.34.0/Dropbox-sdk.min.js" integrity="sha512-PTKs+sPreCz6TLyLj9CYx3LxxPZmY5k1k5Yb5Y5mUQzngf/XUxNdtyWwYjcPcOZJm4wSYiicZr0kotLmDIRFmQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <!-- Example layout boilerplate -->
    <header class="page-header">
        <div class="container">
            <nav>
                <a href="/">
                    <h1>
                        <img src="https://cfl.dropboxstatic.com/static/images/brand/logotype_white-vflRG5Zd8.svg" class="logo" />
                        JavaScript SDK Examples
                    </h1>
                </a>
                <a href="https://github.com/dropbox/dropbox-sdk-js/tree/main/examples/javascript" class="view-source">View Source</a>
            </nav>
            <h2 class="code">
                <a href="/">examples</a> / PKCE browser
            </h2>
        </div>
    </header>

    <!-- Example description and UI -->
    <section class="container main">
        <p>This example shows how to use PKCE in the browser</p>
        <div id="pre-auth-section" style="display:none;">
            <button onClick="doAuth()">Start PKCE Auth Flow</button>
            <p class="info">Once authenticated, it will use the access token to list the files in your root directory.</p>
        </div>

        <div id="authed-section" style="display:none;">
            <p>You have successfully authenticated. Below are the contents of your root directory. They were fetched using the SDK and access token.</p>
            <ul id="files"></ul>
        </div>
    </section>

<script>
  var CLIENT_ID= "fizj6vrhaqvnlix";
  var REDIRECT_URI= "https://chaaad.github.io/TIMECKS/dropbox-test/auth.htm";

  var dbxAuth;
  var authCode_str= getCodeFromUrl();
console.log("authCode_str (usp)",authCode_str)

  // Parses the url and gets the access token if it is in the urls hash
  function getCodeFromUrl() {
    var usp= new URLSearchParams(window.location.search);
    return usp.get("code");
  }

  function initAuth() {
    dbxAuth= new Dropbox.DropboxAuth({
      clientId: CLIENT_ID
    });
  }

  function doAuth() { //from UI
    initAuth();
    dbxAuth.getAuthenticationUrl(REDIRECT_URI, undefined, "code", "offline", undefined, undefined, true)
      .then(auth_url => {
        window.sessionStorage.clear();
        window.sessionStorage.setItem("dbx_codeVerifier", dbxAuth.codeVerifier);
        window.location.href= auth_url; //-->
      })
      .catch(error => console.error(error));
  };

  var dbx;
  var accessToken_str= window.localStorage.getItem("dbx_accessToken");
  var refreshToken_str= window.localStorage.getItem("dbx_refreshToken");

  if (authCode_str) { //hasRedirectedFromAuth
    initAuth();
    dbxAuth.setCodeVerifier(sessionStorage.getItem("dbx_codeVerifier"));
    dbxAuth.getAccessTokenFromCode(REDIRECT_URI, authCode_str)
      .then((response) => {
        accessToken_str= response.result.access_token;
        window.localStorage.setItem("dbx_accessToken", accessToken_str);
        refreshToken_str= response.result.refresh_token;
        window.localStorage.setItem("refreshToken", refreshToken_str);
        dbxAuth.setAccessToken(accessToken_str);
        dbx= new Dropbox.Dropbox({
          auth: dbxAuth
        });
        renderItems();
      })
      .catch(error => {
        console.error(error.error || error);
      });

  } else {
    if (accessToken_str) initDbx({accessToken: accessToken_str});
    else showPageSection("pre-auth-section");
  }

  function initDbx(pO) {
    dbx= new Dropbox.Dropbox(pO);
    dbx.usersGetCurrentAccount()
      .then((response) => {
        console.log(pO, "Auto-Authentication successful:", response);
        renderItems();
      })
      .catch(error => {
        console.error(error);
        dbx= undefined;
        if (pO.accessToken) {
          accessToken_str= undefined;
          window.localStorage.removeItem("dbx_accessToken");
        } else if (pO.refreshToken) {
          refreshToken_str= undefined;
          window.localStorage.removeItem("dbx_refreshToken");
        }

        if (error.status == 401) {
          if (pO.accessToken && refreshToken_str) initDbx({refreshToken: refreshToken_str});
          else showPageSection("pre-auth-section"); ////or doAuth()?????????
        }
      })
    ;
  } //initDbx()

  // Render a list of items to #files
  function renderItems() {
    showPageSection("authed-section");
    dbx.filesListFolder({path: ""}) // C:\Users\chaaad\Dropbox\Apps\TIMECKS
      .then(response => {
        var items_arr= response.result.entries;
        var filesContainer_EL= document.getElementById("files");
        items_arr.forEach(function(item) {
          var li_EL= document.createElement("li");
          li_EL.textContent= item.name;
          filesContainer_EL.appendChild(li_EL);
        });
      })
    ;
  }

  // This example keeps both the authenticated and non-authenticated setions
  // in the DOM and uses this function to show/hide the correct section.
  function showPageSection(elementId) {
    document.getElementById(elementId).style.display= "block";
  }

</script>

</body>

</html>
