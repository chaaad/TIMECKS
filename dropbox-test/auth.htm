<!doctype html>
<html>

<head>
    <title>Dropbox JavaScript SDK</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.34.0/Dropbox-sdk.min.js" integrity="sha512-PTKs+sPreCz6TLyLj9CYx3LxxPZmY5k1k5Yb5Y5mUQzngf/XUxNdtyWwYjcPcOZJm4wSYiicZr0kotLmDIRFmQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <!-- Example layout boilerplate -->
    <header class="page-header">
        <div class="container">
            <nav>
                <a href="/">
                    <h1>
                        <img src="https://cfl.dropboxstatic.com/static/images/brand/logotype_white-vflRG5Zd8.svg" class="logo" />
                        JavaScript SDK Examples
                    </h1>
                </a>
                <a href="https://github.com/dropbox/dropbox-sdk-js/tree/main/examples/javascript" class="view-source">View Source</a>
            </nav>
            <h2 class="code">
                <a href="/">examples</a> / PKCE browser
            </h2>
        </div>
    </header>

    <!-- Example description and UI -->
    <section class="container main">
        <p>This example shows how to use PKCE in the browser</p>
        <div id="pre-auth-section" style="display:none;">
            <button onClick="dBX.doAuth()">Start PKCE Auth Flow</button>
            <p class="info">Once authenticated, it will use the access token to list the files in your root directory.</p>
        </div>

        <div id="authed-section" style="display:none;">
            <p>You have successfully authenticated. Below are the contents of your root directory. They were fetched using the SDK and access token.</p>
            <ul id="files"></ul>
        </div>
    </section>

<script>
// Render a list of items to #files
function renderItems() {
  showPageSection("authed-section");
  dBX.api.filesListFolder({path: ""}) // C:\Users\chaaad\Dropbox\Apps\TIMECKS
    .then(response => {
      var items_arr= response.result.entries;
      var filesContainer_EL= document.getElementById("files");
      items_arr.forEach(function(item) {
        var li_EL= document.createElement("li");
        li_EL.textContent= item.name;
        filesContainer_EL.appendChild(li_EL);
      });
    })
  ;
}

// This example keeps both the authenticated and non-authenticated setions
// in the DOM and uses this function to show/hide the correct section.
function showPageSection(elementId) {
  document.getElementById(elementId).style.display= "block";
}



const dBX= {
  CLIENT_ID: "fizj6vrhaqvnlix",
  CLIENT_SECRET: "k1jhpcjaavnwg7m",
  REDIRECT_URI: "https://chaaad.github.io/TIMECKS/dropbox-test/auth.htm",

  //app
  //accessToken_str, refreshToken_str

  //auth;
  //authCode_str: getCodeFromUrl(),

  init: function() {
    var usp= new URLSearchParams(window.location.search); //Parses the url and gets the access token if it is in the urls hash
    var authCode_str= usp.get("code");

    if (authCode_str) { //hasRedirectedFromAuth
      history.replaceState("", document.title, window.location.pathname); //url remove hash
      dBX.initAuth();
      dBX.auth.setCodeVerifier(sessionStorage.getItem("dbx_codeVerifier_key"));
      dBX.auth.getAccessTokenFromCode(dBX.REDIRECT_URI, authCode_str)
        .then((response) => {
          dBX.accessToken_str= response.result.access_token;
          dBX.ls("dbx_accessToken", dBX.accessToken_str); //set
          dBX.refreshToken_str= response.result.refresh_token;
          dBX.ls("dbx_refreshToken", dBX.refreshToken_str); //set
          dBX.auth.setAccessToken(dBX.accessToken_str);
          dBX.api= new Dropbox.Dropbox({
            auth: dBX.auth
          });
renderItems();
        })
        .catch(function(err) {
          dBX.msg_err(err);
        })

    } else { //normal page
      dBX.accessToken_str= dBX.ls("dbx_accessToken"); //get
      dBX.refreshToken_str= dBX.ls("dbx_refreshToken"); //get

      if (dBX.accessToken_str || dBX.refreshToken_str) dBX.initApi();
else showPageSection("pre-auth-section"); //display button that starts auth
    }
  }, //init()

  ls: function(key, v) { //localStorage: get, set, v="" to rem
    if (v != undefined) {
      if (v == "") window.localStorage.removeItem(key); //rem
      else window.localStorage.setItem(key, v); //set
    } else {
      return window.localStorage.getItem(key); //get
    }
  },

  initAuth: function() {
    dBX.auth= new Dropbox.DropboxAuth({
      clientId: dBX.CLIENT_ID
    });
  },

  doAuth: function() {
    dBX.initAuth();
    dBX.auth.getAuthenticationUrl(dBX.REDIRECT_URI, undefined, "code", "offline", undefined, undefined, true)
      .then(auth_url => {
        //window.sessionStorage.clear();
        dBX.ls("dbx_codeVerify_key", dBX.auth.codeVerifier || ""); //set
        window.location.href= auth_url; //-->
      })
      .catch(function(err) {
        dBX.msg_err(err);
      })
  },


  initApi: function() {
    var pO;
    if (dBX.accessToken_str) pO= {accessToken: dBX.accessToken_str};
    else pO= {clientId: dBX.CLIENT_ID, clientSecret: dBX.CLIENT_SECRET, refreshToken: dBX.refreshToken_str};

    dBX.api= new Dropbox.Dropbox(pO);
    dBX.api.usersGetCurrentAccount()
      .then((response) => {
        console.log(pO, "Auto-Authentication successful:", response);
renderItems();
      })
      .catch(err => {
        dBX.msg_err(err);

        dBX.api= undefined;
        if (pO.accessToken) {
          dBX.accessToken_str= undefined;
          dBX.ls("dbx_accessToken", ""); //rem
        } else if (pO.refreshToken) {
          dBX.refreshToken_str= undefined;
          dBX.ls("dbx_refreshToken", ""); //rem
        }

        if (pO.accessToken && dBX.refreshToken_str) {
            //accessToken failed (prob error.status 401), try refreshToken
            dBX.initApi(pO);

        } else {
          //refreshToken failed, do auth from the top
          dBX.doAuth();
        }
      })
    ;
  }, //initApi()


//var fileContent_str= JSON.stringify( {Hello: "world!", ts: Date.now()} );
//dBX.uploadData("/alarms.json", fileContent_str);
  uploadData: function(filePath_str, fileContent_str) {
    //results_H2.textContent= "";

    dBX.api.filesUpload({
      path: filePath_str,
      contents: fileContent_str,
      mode: {".tag": "overwrite"} // Optional: Overwrite if the file already exists
    })
      .then(function(response) {
        //results_H2.innerHTML= "UPLOAD:<br>" +fileContent_str;
      })
      .catch(function(err) {
        dBX.msg_err(err);
      })
    ;
  }, //uploadData()

//var fileContent_str= dBX.downloadData("/alarms.json");
  downloadData: function(filePath_str) {
    //results_H2.textContent= "";

    dBX.api.filesDownload({path: filePath_str}) // Use the full path, starting with a '/'
      .then(function(response) {
        //The response contains a 'fileBlob' field with the file data
        const file_blob= response.result.fileBlob;

        //Use FileReader to read the Blob content in the browser
        const reader= new FileReader();
        reader.onloadend= function() {
          //results_H2.innerHTML= "DOWNLOAD:<br>" +reader.result;
          //console.log(reader.result); //This will print the file content
        };
        reader.readAsText(file_blob); //Read the blob as plain text
      })
      .catch(function(err) {
        dBX.msg_err(err);
      })
    ;
  }, //downloadData()

  msg_err: function(err) {
    //results_H2.textContent= "Error, see console for details";
    console.error(err.error || err);
  }

}; //dBX

dBX.init(); //self init

</script>

</body>

</html>
